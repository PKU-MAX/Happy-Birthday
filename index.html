<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ç« é±¼å¤§å†’é™©ï¼šæ··ä¹±æµ·åŸŸ</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        /* --- 1. åŸºç¡€è®¾ç½®ä¸é«˜çº§è´¨æ„Ÿ --- */ 
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; } 

        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif; 
            background-color: #333; 
            user-select: none; -webkit-user-select: none; 
            touch-action: none; 
        } 

        /* --- 2. æ¸¸æˆå®¹å™¨ä¸åŠ¨æ€èƒŒæ™¯ --- */ 
        #gameWrapper { 
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; 
            /* å‡çº§ï¼šåŠ å…¥ subtle çš„æµåŠ¨åŠ¨ç”»ï¼Œæ›´åƒå¤§æµ· */
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); 
            background-size: 100% 200%;
            animation: oceanFlow 10s ease infinite alternate;
            z-index: 100; 
            overflow: hidden; 
            transition: transform 0.8s ease-in; 
        } 
        
        @keyframes oceanFlow {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 20%; }
        }

        canvas#gameCanvas { display: block; width: 100%; height: 100%; } 

        /* --- 3. UI ç•Œé¢ (HUD) - æ‚¬æµ®èƒ¶å›Šé£æ ¼ --- */ 
        .hud { 
            position: absolute; top: 15px; left: 15px; right: 15px; 
            display: flex; justify-content: space-between; align-items: flex-start; 
            pointer-events: none; z-index: 20; 
        } 

        /* ç”Ÿå‘½å€¼èƒ¶å›Š */ 
        .life-container { 
            font-size: 1.4rem; color: #ff6b6b; 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(5px);
            padding: 8px 18px; 
            border-radius: 50px; 
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            letter-spacing: 2px;
        } 

        /* åˆ†æ•°æ¿èƒ¶å›Š */ 
        .score-board { 
            text-align: right; 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(5px);
            padding: 10px 20px; 
            border-radius: 25px; 
            border: 3px solid #fff; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        } 

        .score-big { 
            font-size: 2.2rem; 
            /* æ¸å˜æ–‡å­—æ•ˆæœ */
            background: linear-gradient(to bottom, #ff9ff3, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900; 
            line-height: 1;
        } 
        .score-sub { 
            font-size: 1.1rem; 
            color: #57606f; /* æ·±è“ç°è‰²ï¼Œæ¯”çº¯ç°æ›´é«˜çº§ */
            margin-top: 2px;
        } 

        /* --- 4. ç£¨ç ‚ç»ç’ƒè´¨æ„Ÿå¼¹çª— --- */ 
        .ui-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            background: rgba(0, 30, 60, 0.2); /* è½»å¾®çš„æµ·è“åº•è‰² */
            z-index: 50; 
            backdrop-filter: blur(8px); /* èƒŒæ™¯è™šåŒ–æ›´å¼º */
        } 
        .hidden { display: none !important; } 

        .card { 
            /* æ ¸å¿ƒå‡çº§ï¼šç£¨ç ‚ç»ç’ƒå¡ç‰‡ */
            background: rgba(255, 255, 255, 0.9); 
            width: 85%; max-width: 360px; 
            padding: 35px 25px; 
            border-radius: 40px; 
            text-align: center; 
            box-shadow: 0 25px 50px rgba(0, 10, 60, 0.15), inset 0 0 0 2px rgba(255,255,255,1);
            animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* æ›´æœ‰å¼¹æ€§çš„åŠ¨ç”» */
        } 

        h2 { 
            margin: 0 0 15px; 
            color: #2f3542; 
            font-size: 2.2rem; 
            text-shadow: 2px 2px 0px rgba(230,230,230,1);
        } 

        p { 
            color: #57606f; /* æå‡æ­£æ–‡å¯¹æ¯”åº¦ */
            font-size: 1.25rem; 
            line-height: 1.6; 
            margin-bottom: 25px; 
        } 
        
        /* è¯´æ˜æ¡†æ ·å¼ä¼˜åŒ– */
        .info-box {
            font-size: 1rem; 
            text-align: left; 
            background: #f1f2f6; 
            color: #2f3542;
            padding: 15px 20px; 
            border-radius: 20px;
            margin-bottom: 25px;
            border: 2px solid #fff;
        }
        
        button.btn { 
            /* ç³–æœæŒ‰é’® */
            background: linear-gradient(135deg, #ff9ff3 0%, #feca57 100%); 
            border: none; 
            padding: 15px 50px; 
            font-size: 1.5rem; 
            color: white; 
            border-radius: 50px; 
            cursor: pointer; 
            font-family: inherit; 
            /* å¢åŠ å†…å‘å…‰å’Œæ›´æŸ”å’Œçš„æŠ•å½± */
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3), inset 0 2px 0 rgba(255,255,255,0.4); 
            transition: transform 0.2s, box-shadow 0.2s; 
            outline: none; 
            pointer-events: auto; 
            touch-action: manipulation; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        } 
        button.btn:active { 
            transform: scale(0.95) translateY(2px); 
            box-shadow: 0 5px 10px rgba(255, 107, 107, 0.3); 
        } 

        /* --- 5. åº†ç¥é¡µé¢å‡çº§ --- */ 
        #celebrationWrapper { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; opacity: 0; 
            /* æ›´åŠ æ¢¦å¹»çš„ç´«è‰²æ¸å˜ */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            justify-content: center; align-items: center; 
            z-index: 200; transition: opacity 1.5s; 
        } 
        .cel-content { 
            position: relative; z-index: 10; text-align: center; color: white; 
            max-width: 90%;
        } 
        
        /* çº¯CSS ç« é±¼åŠåŠ¨ç”» */ 
        .oct-show { position: relative; width: 160px; height: 180px; margin: 0 auto 30px; animation: float 3s infinite ease-in-out; } 
        .oct-head { 
            width: 140px; height: 130px; background: #ff9aa2; border-radius: 50% 50% 45% 45%; position: relative; 
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.1); /* å¢åŠ ç«‹ä½“æ„Ÿ */
        } 
        .oct-eye { position: absolute; top: 45px; width: 32px; height: 40px; background: #333; border-radius: 50%; } 
        .oct-eye.l { left: 28px; } .oct-eye.r { right: 28px; } 
        .oct-eye::after{ content:''; position:absolute; top:8px; left:8px; width:12px; height:12px; background:#fff; border-radius:50%;} 
        .oct-mouth { position: absolute; bottom: 20px; left: 50%; transform: translate(-50%); width: 20px; height: 10px; border-bottom: 4px solid #d63384; border-radius:0 0 50% 50%; } 
        .hat-final { 
            position: absolute; top: -60px; left: 10px; font-size: 80px; 
            transform: rotate(-15deg); 
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
        } 
        
        h1.win-title { 
            font-size: 3.2rem; margin: 10px 0; 
            text-shadow: 0 5px 0px rgba(0,0,0,0.1); 
            color: #fff;
        } 
        
        .win-msg {
            font-size: 1.5rem; line-height: 1.6;
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            display: inline-block;
            margin-top: 10px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        @keyframes popIn { 0%{transform: scale(0.6); opacity:0} 100%{transform: scale(1); opacity:1} } 
        @keyframes float { 0%,100%{transform: translateY(0)} 50%{transform: translateY(-20px)} } 
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } } 

    </style>
</head>
<body>

    <div id="gameWrapper">
        <canvas id="gameCanvas"></canvas>
        
        <!-- æ¸¸æˆä¸­çš„æ˜¾ç¤º -->
        <div class="hud">
            <div class="life-container" id="lifeEl">â¤â¤â¤</div>
            <div class="score-board">
                <div class="score-big"><span id="scoreEl">0</span>/23</div>
                <div class="score-sub">æ”¶é›†ç”Ÿæ—¥å¸½</div>
            </div>
        </div>

        <!-- 1. å¼€å§‹èœå• -->
        <div class="ui-overlay" id="startScreen">
            <div class="card">
                <h2>ğŸ™ æ··ä¹±æµ·åŸŸ</h2>
                <p>ä»Šå¤©æ˜¯å°ç« é±¼çš„23å²ç”Ÿæ—¥ï¼Œ<br>ä½†åº†ç¥ç”¨çš„å¸½å­æ•£è½åœ¨æµ·é‡Œäº†ï¼<br>æ”¶é›† <b style="color:#ff6b6b; font-size:1.3em;">23</b> ä¸ªå¸½å­æ¥å¼€æ´¾å¯¹ï¼</p>
                
                <div class="info-box">
                    <b style="color:#ff9f43">âœ¨ ç©æ³•ï¼š</b><br>
                    ğŸ‘† æŒ‰ä½å±å¹• = ä¸Šæµ®<br>
                    ğŸ‘‡ æ¾æ‰‹ = ä¸‹æ½œ<br>
                    ğŸ° åƒè›‹ç³•å›è¡€ï¼Œèº²å¼€éšœç¢ç‰©ï¼ 
                </div>
                
                <button class="btn" id="startBtn">å¼€å§‹å†’é™©</button>
            </div>
        </div>

        <!-- 2. å¤±è´¥/æš‚åœèœå• -->
        <div class="ui-overlay hidden" id="gameOverScreen">
            <div class="card">
                <h2>ğŸ˜µ æ™•å€’äº†ï¼</h2>
                <p>æµ·é‡Œçš„åƒåœ¾å¤ªå¤šäº†...<br>å°ç« é±¼éœ€è¦ä¼‘æ¯ä¸€ä¸‹â€¦â€¦</p>
                <div style="height:20px;"></div>
                <button class="btn" id="retryBtn">å†è¯•ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <!-- åº†ç¥é¡µé¢ -->
    <div id="celebrationWrapper">
        <canvas id="fwCanvas" style="position:absolute;top:0;left:0;"></canvas>
        <div class="cel-content">
            <div class="oct-show">
                <div class="hat-final">ğŸ‘‘</div>
                <div class="oct-head">
                    <div class="oct-eye l"></div><div class="oct-eye r"></div>
                    <div class="oct-mouth"></div>
                </div>
            </div>
            <h1 class="win-title">å°ç« é±¼ç”Ÿæ—¥å¿«ä¹ï¼</h1>
            <div class="win-msg">
                èƒ½é‡åˆ°ä½ è¯´æ˜æˆ‘å¾ˆå¹¸è¿<br>æ–°çš„ä¸€å¹´æˆ‘æŠŠå¥½è¿åˆ†ç»™ä½ ~<br>âœ¨ <b>2025å…ƒæ—¦å¿«ä¹ Â· æ¯å¤©éƒ½å¼€å¿ƒ</b> âœ¨
            </div>
        </div>
    </div>

    <script>
        /** 
         * æ¸¸æˆæ ¸å¿ƒä»£ç  (é€»è¾‘ä¿æŒå®Œå…¨ä¸€è‡´ï¼Œæœªåšä¿®æ”¹)
         */ 
        const canvas = document.getElementById('gameCanvas'); 
        const ctx = canvas.getContext('2d'); 
        const scoreEl = document.getElementById('scoreEl'); 
        const lifeEl = document.getElementById('lifeEl'); 
        const startScreen = document.getElementById('startScreen'); 
        const gameOverScreen = document.getElementById('gameOverScreen'); 
        const gameWrapper = document.getElementById('gameWrapper'); 
        
        let width, height; 
        const TARGET = 23; 

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('startBtn').addEventListener('click', (e) => { 
            e.stopPropagation(); 
            startGame(); 
        }); 
        document.getElementById('retryBtn').addEventListener('click', (e) => { 
            e.stopPropagation(); 
            startGame(); 
        }); 

        // å±å¹•é€‚é…
        function resize() { 
            width = canvas.width = window.innerWidth; 
            height = canvas.height = window.innerHeight; 
        } 
        window.addEventListener('resize', resize); 
        resize(); 

        // --- æ¸¸æˆçŠ¶æ€ --- 
        let state = { 
            playing: false, 
            frames: 0, 
            score: 0, 
            hp: 3, 
            speed: 3.5 
        }; 

        let inputActive = false; 

        // --- è¾“å…¥ç›‘å¬ --- 
        function handleInputStart(e) { 
            if (e.target.tagName === 'BUTTON') return; 
            if (state.playing) { 
                inputActive = true; 
            } 
        } 
        
        function handleInputEnd(e) { 
            inputActive = false; 
        } 

        window.addEventListener('mousedown', handleInputStart); 
        window.addEventListener('touchstart', handleInputStart, {passive: false}); 
        
        window.addEventListener('mouseup', handleInputEnd); 
        window.addEventListener('touchend', handleInputEnd); 
        
        window.addEventListener('keydown', (e) => { if(e.code==='Space') inputActive = true; }); 
        window.addEventListener('keyup', (e) => { if(e.code==='Space') inputActive = false; }); 

        // --- å®ä½“ç±»å®šä¹‰ --- 

        // ä¸»è§’
        const player = { 
            x: 50, y: height/2, r: 22, vy: 0, 
            hurtTimer: 0, 
            draw() { 
                if(this.hurtTimer > 0) { 
                    this.hurtTimer--; 
                    if(Math.floor(Date.now()/50)%2===0) return; 
                } 

                ctx.save(); 
                ctx.translate(this.x, this.y); 
                let rot = inputActive ? -0.3 : 0.2; 
                ctx.rotate(rot); 

                ctx.fillStyle = '#ff9aa2'; 
                ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); 
                
                ctx.fillStyle = '#fff'; 
                if(this.hurtTimer > 0) { 
                    ctx.strokeStyle = '#333'; ctx.lineWidth=2; 
                    ctx.beginPath(); ctx.moveTo(4,-8); ctx.lineTo(12,-2); ctx.stroke(); 
                    ctx.beginPath(); ctx.moveTo(12,-8); ctx.lineTo(4,-2); ctx.stroke(); 
                } else { 
                    ctx.beginPath(); ctx.arc(8,-5,6,0,Math.PI*2); ctx.fill(); 
                    ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(10,-5,2,0,Math.PI*2); ctx.fill(); 
                } 
                
                ctx.fillStyle = '#ff9aa2'; 
                let legY = Math.sin(state.frames * 0.2) * 4; 
                ctx.beginPath(); ctx.arc(-10, 18+legY, 7, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.arc(5, 20-legY, 7, 0, Math.PI*2); ctx.fill(); 

                ctx.restore(); 
            }, 
            update() { 
                if(inputActive) this.vy -= 0.45; 
                else this.vy += 0.25; 
                
                this.vy *= 0.96; 
                this.y += this.vy; 

                if(this.y < this.r) { this.y = this.r; this.vy = 0; } 
                if(this.y > height - this.r) { 
                    this.y = height - this.r; 
                    this.vy = -1; 
                } 
            } 
        }; 

        // ç‰©å“ç±» (åŸºç±») 
        class Item { 
            constructor() { 
                this.x = width + 50; 
                this.y = Math.random() * (height - 100) + 50; 
                this.markedForDeletion = false; 
            } 
            update() { 
                this.x -= state.speed; 
                if(this.x < -100) this.markedForDeletion = true; 
            } 
            draw() {} 
            checkCollision(p) { 
                let dx = this.x - p.x; 
                let dy = this.y - p.y; 
                let dist = Math.sqrt(dx*dx + dy*dy); 
                return dist < (p.r + this.r); 
            } 
        } 

        // 1. å¸½å­ 
        class Hat extends Item { 
            constructor() { super(); this.r = 18; this.offset = Math.random()*100; } 
            update() { 
                super.update(); 
                this.y += Math.sin((state.frames + this.offset)*0.05) * 0.5; 
            } 
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); 
                ctx.fillStyle = '#ffd700'; 
                ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(15,10); ctx.lineTo(-15,10); ctx.fill(); 
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,-20,4,0,Math.PI*2); ctx.fill(); 
                ctx.restore(); 
            } 
        } 

        // 2. è›‹ç³•
        class Cake extends Item { 
            constructor() { 
                super(); 
                this.r = 20; 
            } 
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); 
                ctx.fillStyle = '#fff0f5'; ctx.fillRect(-15, -10, 30, 20); 
                ctx.fillStyle = '#ff6b6b'; ctx.fillRect(-15, -10, 30, 5); 
                ctx.fillStyle = '#e55039'; ctx.beginPath(); ctx.arc(0, -12, 5, 0, Math.PI*2); ctx.fill(); 
                ctx.restore(); 
            } 
        } 

        // 3. æµ·èƒ†
        class Urchin extends Item { 
            constructor() { super(); this.r = 20; this.angle = 0; } 
            update() { 
                super.update(); 
                this.angle += 0.1; 
            } 
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); 
                ctx.rotate(this.angle); 
                ctx.fillStyle = '#2d3436'; 
                ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill(); 
                for(let i=0; i<8; i++) { 
                    ctx.rotate(Math.PI/4); 
                    ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(3,-25); ctx.lineTo(-3,-25); ctx.fill(); 
                } 
                ctx.restore(); 
            } 
        } 

        // 4. è‡­é´å­
        class Boot extends Item { 
            constructor() { 
                super(); 
                this.r = 25; 
                this.spin = (Math.random()-0.5) * 0.05; 
                this.rot = 0; 
            } 
            update() { super.update(); this.rot += this.spin; } 
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rot); 
                ctx.fillStyle = '#636e72'; 
                ctx.beginPath(); 
                ctx.moveTo(-10, -20); ctx.lineTo(10, -20); 
                ctx.lineTo(10, 10); ctx.lineTo(25, 10); 
                ctx.lineTo(25, 25); ctx.lineTo(-10, 25); 
                ctx.closePath(); ctx.fill(); 
                ctx.fillStyle = '#55efc4'; ctx.globalAlpha=0.6; 
                ctx.beginPath(); ctx.arc(0, -30, 5, 0, Math.PI*2); ctx.fill(); 
                ctx.globalAlpha=1; 
                ctx.restore(); 
            } 
        } 

        // 5. é“é”š
        class Anchor extends Item { 
            constructor() { 
                super(); 
                this.r = 30; 
                if (Math.random() > 0.5) { 
                    this.y = 40; 
                    this.isTop = true; 
                } else { 
                    this.y = height - 40; 
                    this.isTop = false; 
                } 
            } 
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); 
                ctx.fillStyle = '#2c3e50'; 
                if(this.isTop) { 
                    ctx.fillRect(-5, -50, 10, 60); 
                    ctx.beginPath(); ctx.arc(0, 10, 20, 0, Math.PI, false); ctx.lineTo(0,0); ctx.fill(); 
                } else { 
                    ctx.fillRect(-5, -10, 10, 60); 
                    ctx.beginPath(); ctx.arc(0, -10, 20, 0, Math.PI, true); ctx.lineTo(0,0); ctx.fill(); 
                } 
                ctx.restore(); 
            } 
        } 

        // --- ç®¡ç†å™¨ --- 
        let items = []; 
        let particles = []; 

        function updateHUD() { 
            scoreEl.innerText = state.score; 
            let hearts = ''; 
            for(let i=0; i<state.hp; i++) hearts += 'â¤'; 
            for(let i=state.hp; i<3; i++) hearts += 'ğŸ¤'; 
            lifeEl.innerText = hearts; 
        } 

        function spawnParticles(x, y, color) { 
            for(let i=0; i<10; i++) { 
                particles.push({ 
                    x: x, y: y, 
                    vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8, 
                    life: 1, color: color
                }); 
            } 
        } 

        function startGame() { 
            startScreen.classList.add('hidden'); 
            gameOverScreen.classList.add('hidden'); 
            state.playing = true; 
            state.score = 0; 
            state.hp = 3; 
            state.frames = 0; 
            items = []; 
            particles = []; 
            player.y = height/2; player.vy = 0; player.hurtTimer = 0; 
            
            updateHUD(); 
            loop(); 
        } 

        function gameOver() { 
            state.playing = false; 
            gameWrapper.style.animation = 'shake 0.5s'; 
            setTimeout(() => gameWrapper.style.animation = '', 500); 
            
            setTimeout(() => { 
                gameOverScreen.classList.remove('hidden'); 
            }, 500); 
        } 

        function gameWin() { 
            state.playing = false; 
            const cel = document.getElementById('celebrationWrapper'); 
            // æ¸¸æˆå±‚ä¸Šç§»æ¶ˆå¤±
            gameWrapper.style.transform = 'translateY(-100vh)'; 
            cel.style.display = 'flex'; 
            setTimeout(() => { 
                cel.style.opacity = 1; 
                startFireworks(); 
            }, 500); 
        } 

        function spawner() { 
            if(state.frames % 60 === 0) items.push(new Hat()); 
            if(state.frames % 90 === 0) { 
                let r = Math.random(); 
                if(r < 0.4) items.push(new Urchin()); 
                else if(r < 0.7) items.push(new Boot()); 
                else items.push(new Anchor()); 
            } 
            let cakeRate = state.hp < 3 ? 0.005 : 0.001; 
            if(Math.random() < cakeRate) items.push(new Cake()); 
        } 

        function loop() { 
            if(!state.playing) return; 
            
            ctx.clearRect(0,0,width,height); 
            state.frames++; 

            player.update(); 
            player.draw(); 
            
            spawner(); 

            for (let i = items.length - 1; i >= 0; i--) { 
                let it = items[i]; 
                it.update(); 
                it.draw(); 

                if (it.checkCollision(player)) { 
                    if (it instanceof Hat) { 
                        state.score++; 
                        items.splice(i, 1); 
                        spawnParticles(it.x, it.y, '#ffd700'); 
                        if (state.score >= TARGET) gameWin(); 
                    } 
                    else if (it instanceof Cake) { 
                        if (state.hp < 3) state.hp++; 
                        items.splice(i, 1); 
                        spawnParticles(it.x, it.y, '#ff6b6b'); 
                    } 
                    else { 
                        if (player.hurtTimer === 0) { 
                            state.hp--; 
                            player.hurtTimer = 60; 
                            spawnParticles(player.x, player.y, '#333'); 
                            
                            gameWrapper.style.background = '#ff6b6b'; 
                            setTimeout(() => { 
                                gameWrapper.style.background = 'linear-gradient(180deg, #4facfe 0%, #00f2fe 100%)'; 
                            }, 100); 

                            if(state.hp <= 0) gameOver(); 
                        } 
                    } 
                    updateHUD(); 
                } 
                else if (it.markedForDeletion) { 
                    items.splice(i, 1); 
                } 
            } 

            for(let i=particles.length-1; i>=0; i--) { 
                let p = particles[i]; 
                p.x += p.vx; p.y += p.vy; p.life -= 0.05; 
                if(p.life <=0) { particles.splice(i,1); continue; } 
                ctx.globalAlpha = p.life; 
                ctx.fillStyle = p.color; 
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); 
            } 
            ctx.globalAlpha = 1; 

            requestAnimationFrame(loop); 
        } 

        function startFireworks() { 
            const fwC = document.getElementById('fwCanvas'); 
            const fwCtx = fwC.getContext('2d'); 
            fwC.width = window.innerWidth; 
            fwC.height = window.innerHeight; 
            let fws = []; 
            
            function createFW(x,y) { 
                const colors = ['#f1c40f','#e74c3c','#9b59b6','#2ecc71']; 
                const c = colors[Math.floor(Math.random()*colors.length)]; 
                for(let i=0;i<30;i++) { 
                    fws.push({ 
                        x:x, y:y, color:c, 
                        vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, 
                        life:1
                    }); 
                } 
            } 

            setInterval(() => createFW(Math.random()*width, Math.random()*height/2), 800); 

            function fwLoop() { 
                fwCtx.clearRect(0,0,width,height); 
                for(let i=fws.length-1; i>=0; i--) { 
                    let p = fws[i]; 
                    p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=0.02; 
                    fwCtx.globalAlpha=p.life; fwCtx.fillStyle=p.color; 
                    fwCtx.beginPath(); fwCtx.arc(p.x,p.y,3,0,Math.PI*2); fwCtx.fill(); 
                    if(p.life<=0) fws.splice(i,1); 
                } 
                requestAnimationFrame(fwLoop); 
            } 
            fwLoop(); 
        } 

    </script>
</body>
</html>
